
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Kaleido Warp — Reels (Save Bar)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg:#0b0c10; --panel:#111318; --text:#e5e7eb; --muted:#9aa0a6; --border:#232833; }
  *{ box-sizing:border-box }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial }
  header{ background:#111318; border-bottom:1px solid var(--border); padding:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; position:sticky; top:0; z-index:5 }
  main{ display:grid; grid-template-columns:1fr 380px; gap:10px; height:calc(100vh - 60px); padding:10px }
  body.collapse main{ grid-template-columns:1fr; }
  @media (max-width: 1024px){ main{ grid-template-columns:1fr } }
  .panel{ background:#111318; border:1px solid var(--border); border-radius:12px; overflow:hidden; display:flex; flex-direction:column; min-height:280px }
  .panel h2{ margin:0; padding:8px 12px; background:#0e1116; color:var(--muted); font-size:13px; border-bottom:1px solid var(--border) }
  .pane{ flex:1; display:flex; align-items:center; justify-content:center; background:#000; position:relative; overflow:auto }
  .zoomWrap{ transform-origin: top left; }
  canvas{ display:block; background:#000 }
  input,button,select{ background:#171b22; border:1px solid #232833; color:#e5e7eb; border-radius:8px; padding:10px 14px; font-size:14px }
  button.primary{ background:#2563eb; border-color:#1d4ed8 }
  .startBtn{ font-size:16px; padding:12px 18px; background:#10b981; border-color:#059669; }
  .pill{ padding:6px 10px; border-radius:999px; background:#0e1117; border:1px solid #232833; color:#9aa0a6; font-size:12px }
  #recCanvas{ display:none }
  .controls{ padding:10px; overflow:auto; display:flex; flex-direction:column; gap:8px }
  .row{ display:grid; grid-template-columns:130px 1fr 60px; align-items:center; gap:8px }
  .row input[type=range]{ width:100% }
  .val{ color:#9aa0a6; font-variant-numeric: tabular-nums; text-align:right }
  .countdown{ position:absolute; inset:0; display:none; place-items:center; background:rgba(0,0,0,0.35); font-size:72px; font-weight:700; }
  .countdown.show{ display:grid; }
  .result{ padding:0; border-top:1px solid var(--border); background:#0e1116; display:none; flex-direction:column; gap:0 }
  video{ width:100%; border-radius:0 }
  .saveBar{ display:flex; gap:10px; padding:10px; background:#0b0f15; border-top:1px solid var(--border); position:sticky; bottom:0; z-index:4; }
  .saveBtn{ background:#f59e0b; border-color:#d97706; font-weight:600 }
  .reRecord{ background:#334155; border-color:#1f2937 }
</style>
</head>
<body>
<header>
  <input id="file" type="file" accept="image/*" />
  <button id="presetLenslist" class="primary">Lenslist Warp</button>
  <button id="presetSoft">Soft Spiral</button>
  <button id="presetTunnel">IG Tunnel</button>
  <button id="randomize">Randomize</button>
  <button id="savePreset">Save Preset</button>
  <input type="file" id="loadPreset" accept=".json" style="display:none" />
  <button id="loadPresetBtn">Load Preset</button>
  <label>Preview AR
    <select id="previewAR">
      <option value="orig">Original</option>
      <option value="1:1">1:1</option>
      <option value="4:5">4:5</option>
      <option value="3:2">3:2</option>
      <option value="16:9">16:9</option>
      <option value="9:16" selected>9:16</option>
    </select>
  </label>
  <label style="display:flex;align-items:center;gap:6px;">Scale
    <input id="scaleSlider" type="range" min="0.4" max="1.0" step="0.05" value="1.00" style="width:140px;">
    <span id="scaleVal" class="pill">100%</span>
  </label>
  <button id="fitBtn">Fit</button>
  <button id="toggleControls">Toggle Controls</button>
  <button id="startBtn" class="startBtn" disabled>▶ Record 15s</button>
  <span class="pill" id="status">Load an image to start…</span>
</header>
<main>
  <div class="panel">
    <h2>Preview</h2>
    <div class="pane">
      <div class="zoomWrap" id="zoomWrap">
        <canvas id="preview"></canvas>
        <div id="countdown" class="countdown">3</div>
      </div>
    </div>
    <div class="result" id="result">
      <video id="vid" controls playsinline></video>
      <div class="saveBar">
        <button id="saveBtn" class="saveBtn">Save video</button>
        <button id="againBtn" class="reRecord">Record again</button>
        <a id="downloadLink" href="#" download style="display:none">Download</a>
      </div>
    </div>
  </div>
  <div class="panel" id="controlsPanel">
    <h2>Controls</h2>
    <div class="controls" id="controls"></div>
  </div>
</main>
<canvas id="recCanvas" width="1080" height="1920"></canvas>

<script>
const statusEl = document.getElementById('status');
function setStatus(t){ statusEl.textContent = t; }

let params = {
  loopLen:15, spins:1.0, waveCycles:2.0, tilesR:4.0, flowCycles:1.2, tilesT:1.0,
  segments:12, zoom:0.9, spiral:0.06, waveAmp:0.1,
  hole:0.0, feather:0.1, vign:0.25, sat:1.25, glow:0.25, rgbSplit:1
};

const controlDefs = [
  ['spins','Spins/Loop',0,5,0.01],
  ['waveCycles','Wave Cycles',0,10,0.1],
  ['waveAmp','Wave Amp',0,1,0.01],
  ['tilesR','Radial Tiles',1,10,0.1],
  ['flowCycles','Flow Cycles',0,5,0.1],
  ['tilesT','Angular Tiles',1,5,0.1],
  ['segments','Segments',3,32,1],
  ['zoom','Zoom',0.5,1.5,0.01],
  ['spiral','Spiral',-0.5,0.5,0.01],
  ['hole','Hole Size',0,0.6,0.01],
  ['feather','Feather',0,0.5,0.01],
  ['vign','Vignette',0,1,0.01],
  ['sat','Saturation',0,2,0.01],
  ['glow','Glow',0,0.8,0.01],
  ['rgbSplit','RGB Split',0,2,1]
];

const controlsEl = document.getElementById('controls');
function buildControls(){
  controlsEl.innerHTML='';
  for (const [key,label,min,max,step] of controlDefs){
    const row = document.createElement('div'); row.className='row';
    const name = document.createElement('div'); name.textContent = label;
    const rng = document.createElement('input'); rng.type='range'; rng.min=min; rng.max=max; rng.step=step; rng.value=params[key]; rng.id='ctrl-'+key;
    const val = document.createElement('div'); val.className='val'; val.textContent = params[key];
    rng.addEventListener('input', e=>{ params[key]=parseFloat(e.target.value); val.textContent=e.target.value; });
    row.appendChild(name); row.appendChild(rng); row.appendChild(val);
    controlsEl.appendChild(row);
  }
}
buildControls();

const VERT = `#version 300 es
layout(location=0) in vec2 a; out vec2 v; void main(){ v=(a+1.)*.5; gl_Position=vec4(a,0,1);} `;
const FRAG = `#version 300 es
precision highp float; in vec2 v; out vec4 o; uniform sampler2D tex; uniform float tNorm;
uniform int segs; uniform float u_spinsPerLoop,u_waveCycles,u_waveAmp,u_spiral,u_zoom,u_tilesR,u_flowCycles,u_tilesT;
uniform float u_hole,u_feather,u_vign,u_sat,u_glow; uniform int u_rgbSplit;
float mirror(float x){ float m=mod(x,2.0); return (m<=1.0)?m:2.0-m; }
vec2 mirrorWrap(vec2 p){ return vec2(mirror(p.x),mirror(p.y)); }
float luma(vec3 c){ return dot(c, vec3(0.2126,0.7152,0.0722)); }
vec3 satmix(vec3 c,float s){ float g=luma(c); return mix(vec3(g), c, s); }
vec3 rgbSplitSample(vec2 uv,float r){
  float amt=(u_rgbSplit==2)?1.5:0.75; float shift=amt*r*0.0025;
  vec2 dir=normalize(uv-0.5); vec3 col;
  col.r=texture(tex,mirrorWrap(uv+dir*shift)).r;
  col.g=texture(tex,mirrorWrap(uv)).g;
  col.b=texture(tex,mirrorWrap(uv-dir*shift)).b;
  return col;
}
void main(){
  vec2 p=v-0.5; float r=length(p)+1e-6; float ang=atan(p.y,p.x);
  ang+=6.2831853*u_spinsPerLoop*tNorm;
  ang+=u_waveAmp*sin(6.2831853*u_waveCycles*tNorm + r*6.2831853);
  ang+=u_spiral*r*6.2831853; r=pow(r,u_zoom);
  float k=float(max(segs,1)); float sector=6.2831853/k; ang=mod(ang,sector); ang=abs(ang-sector*0.5);
  float s=ang/sector; s=fract(s*max(1.0,u_tilesT)); float t=fract(r*max(1.0,u_tilesR)-tNorm*u_flowCycles);
  vec2 uv=mirrorWrap(vec2(s,t));
  float d=length(v-0.5);
  vec3 col=(u_rgbSplit==0)?texture(tex,uv).rgb:rgbSplitSample(uv,d);
  col+=col*smoothstep(0.0,1.0,1.0-d)*u_glow;
  col*=1.0-u_vign*smoothstep(0.4,0.95,d);
  col=satmix(col,u_sat);
  float mask=smoothstep(u_hole,u_hole+max(u_feather,1e-4),d);
  col*=mask;
  o=vec4(col,1.0);
}`;

function makeRenderer(canvas){
  const gl = canvas.getContext('webgl2', {premultipliedAlpha:false,preserveDrawingBuffer:false});
  if(!gl){ alert('WebGL2 is required'); throw new Error('WebGL2 not available'); }
  function sh(t,s){ const o=gl.createShader(t); gl.shaderSource(o,s); gl.compileShader(o); if(!gl.getShaderParameter(o,gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(o)); return o; }
  const prog=gl.createProgram(); gl.attachShader(prog,sh(gl.VERTEX_SHADER,VERT)); gl.attachShader(prog,sh(gl.FRAGMENT_SHADER,FRAG)); gl.linkProgram(prog);
  if(!gl.getProgramParameter(prog,gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(prog));
  const buf=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,buf); gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),gl.STATIC_DRAW);
  gl.enableVertexAttribArray(0); gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0);
  const loc={}; ['tex','tNorm','segs','u_spinsPerLoop','u_waveCycles','u_waveAmp','u_spiral','u_zoom','u_tilesR','u_flowCycles','u_tilesT','u_hole','u_feather','u_vign','u_sat','u_glow','u_rgbSplit'].forEach(n=>loc[n]=gl.getUniformLocation(prog,n));
  const tex=gl.createTexture(); gl.bindTexture(gl.TEXTURE_2D,tex);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR); gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.MIRRORED_REPEAT); gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.MIRRORED_REPEAT);
  function upload(img){ gl.bindTexture(gl.TEXTURE_2D,tex); gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true); gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,img); }
  function draw(tNorm){ gl.useProgram(prog); gl.activeTexture(gl.TEXTURE0); gl.bindTexture(gl.TEXTURE_2D,tex); gl.uniform1i(loc.tex,0);
    gl.uniform1f(loc.tNorm,tNorm); gl.uniform1i(locs.segs,params.segments|0); gl.uniform1f(locs.u_spinsPerLoop,params.spins);
    gl.uniform1f(locs.u_waveCycles,params.waveCycles); gl.uniform1f(locs.u_waveAmp,params.waveAmp);
    gl.uniform1f(locs.u_spiral,params.spiral); gl.uniform1f(locs.u_zoom,params.zoom); gl.uniform1f(locs.u_tilesR,params.tilesR);
    gl.uniform1f(locs.u_flowCycles,params.flowCycles); gl.uniform1f(locs.u_tilesT,params.tilesT); gl.uniform1f(locs.u_hole,params.hole);
    gl.uniform1f(locs.u_feather,params.feather); gl.uniform1f(locs.u_vign,params.vign); gl.uniform1f(locs.u_sat,params.sat);
    gl.uniform1f(locs.u_glow,params.glow); gl.uniform1i(locs.u_rgbSplit,params.rgbSplit|0);
    gl.viewport(0,0,canvas.width,canvas.height); gl.drawArrays(gl.TRIANGLES,0,6); }
  const locs = loc;
  return { gl, upload, draw, locs };
}

const previewCanvas = document.getElementById('preview');
const countdownEl = document.getElementById('countdown');
const zoomWrap = document.getElementById('zoomWrap');
const recCanvas = document.getElementById('recCanvas');
const resultEl = document.getElementById('result');
const vidEl = document.getElementById('vid');
const saveBtn = document.getElementById('saveBtn');
const againBtn = document.getElementById('againBtn');
let preview, recRenderer, loaded=false, imW=0, imH=0, imgSrc=null, startTime=0, lastBlob=null;

let scale = 1.00;
function applyScale(){ zoomWrap.style.transform = 'scale(' + scale.toFixed(2) + ')'; document.getElementById('scaleVal').textContent = Math.round(scale*100)+'%'; }
applyScale();
document.getElementById('scaleSlider').addEventListener('input', e=>{ scale = parseFloat(e.target.value); applyScale(); });

document.getElementById('fitBtn').addEventListener('click', ()=>{
  const pane = zoomWrap.parentElement;
  const availW = pane.clientWidth - 16;
  const availH = pane.clientHeight - 16;
  const sX = availW / previewCanvas.width;
  const sY = availH / previewCanvas.height;
  scale = Math.min(1, Math.max(0.4, Math.min(sX, sY)));
  document.getElementById('scaleSlider').value = scale.toFixed(2);
  applyScale();
});

document.getElementById('toggleControls').addEventListener('click', ()=>{
  document.body.classList.toggle('collapse');
  setTimeout(()=>document.getElementById('fitBtn').click(), 0);
});

function resizePreview(){
  const container = previewCanvas.parentElement;
  const pane = container.parentElement;
  const w = Math.max(360, Math.floor(pane.clientWidth - 40));
  const arSel = document.getElementById('previewAR').value;
  let ar;
  if(arSel==='orig'){ ar = (imW && imH) ? (imW/imH) : 9/16; }
  else { const [a,b]=arSel.split(':').map(Number); ar=a/b; }
  const h = Math.round(w / ar);
  previewCanvas.width = w; previewCanvas.height = h;
  if(preview && preview.gl) preview.gl.viewport(0,0,w,h);
  document.getElementById('fitBtn').click();
}
window.addEventListener('resize', resizePreview);
document.getElementById('previewAR').addEventListener('change', resizePreview);

// Image loading
document.getElementById('file').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    const img=new Image();
    img.onload=()=>{
      imW=img.naturalWidth; imH=img.naturalHeight;
      imgSrc = r.result;
      try{ if(!preview) preview = makeRenderer(previewCanvas); } catch(err){ setStatus('WebGL2 error: '+err.message); return; }
      preview.upload(img); loaded=true; startTime=performance.now(); setStatus('Image loaded — recording will auto-start…');
      resizePreview();
      setTimeout(()=> startRecording(), 500);
      document.getElementById('startBtn').disabled=false;
    };
    img.src=r.result;
  };
  r.readAsDataURL(f);
});

// Presets
document.getElementById('presetLenslist').onclick=()=>Object.assign(params,{spins:1,waveCycles:2,waveAmp:0.1,tilesR:4,flowCycles:1.2,tilesT:1,segments:12,zoom:0.9,spiral:0.06,hole:0.0,feather:0.1,vign:0.25,sat:1.25,glow:0.25,rgbSplit:1});
document.getElementById('presetSoft').onclick=()=>Object.assign(params,{spins:0.3,waveCycles:1,waveAmp:0.05,tilesR:3,flowCycles:0.5,tilesT:1,segments:8,zoom:1,spiral:0.02,hole:0.0,feather:0.15,vign:0.2,sat:1.1,glow:0.2,rgbSplit:0});
document.getElementById('presetTunnel').onclick=()=>Object.assign(params,{spins:2,waveCycles:3,waveAmp:0.15,tilesR:6,flowCycles:2,tilesT:1,segments:16,zoom:0.8,spiral:0.1,hole:0.0,feather:0.1,vign:0.3,sat:1.3,glow:0.3,rgbSplit:2});
document.getElementById('randomize').onclick=()=>{
  for(const [k,_,min,max,step] of controlDefs){
    const v = Math.round((Math.random()*(max-min)+min)/step)*step;
    params[k]=v;
    const el = document.getElementById('ctrl-'+k);
    if(el){ el.value=v; el.nextElementSibling && (el.nextElementSibling.textContent=v); }
  }
};
document.getElementById('savePreset').onclick=()=>{
  const blob=new Blob([JSON.stringify(params,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='kaleido-preset.json'; a.click(); URL.revokeObjectURL(url);
};
document.getElementById('loadPresetBtn').onclick=()=>document.getElementById('loadPreset').click();
document.getElementById('loadPreset').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{ try{ const obj=JSON.parse(r.result); Object.assign(params,obj); buildControls(); }catch(err){ alert('Invalid preset JSON'); } };
  r.readAsText(f);
};

// Preview animation loop
function loop(t){
  requestAnimationFrame(loop);
  if(!loaded || !preview) return;
  const T = 15.0;
  const tNorm = (((t - startTime)/1000) % T) / T;
  preview.draw(tNorm);
}
requestAnimationFrame(loop);

// Countdown + record
function startRecording(){
  if(!loaded || !imgSrc) return;
  const countdownEl = document.getElementById('countdown');
  countdownEl.classList.add('show');
  [3,2,1].forEach((n,i)=>setTimeout(()=>{ countdownEl.textContent=n; }, i*1000));
  setTimeout(()=>{ countdownEl.classList.remove('show'); doRecord(); }, 3000);
}

function doRecord(){
  resultEl.style.display = 'none'; lastBlob = null;
  recCanvas.width = 1080; recCanvas.height = 1920;
  try{ recRenderer = makeRenderer(recCanvas); } catch(err){ setStatus('WebGL2 error: '+err.message); return; }
  const img = new Image(); img.onload=()=> recRenderer.upload(img); img.src = imgSrc;

  const FPS=30, DUR=15, TOTAL=FPS*DUR;
  const stream = recCanvas.captureStream(FPS);
  const chunks = [];
  let optsList = [
    { mimeType:'video/mp4;codecs=avc1.42E01E,mp4a.40.2', videoBitsPerSecond: 14000000 },
    { mimeType:'video/webm;codecs=vp9', videoBitsPerSecond: 14000000 },
    { mimeType:'video/webm;codecs=vp8', videoBitsPerSecond: 14000000 }
  ];
  let opts = null;
  for(const o of optsList){ if(MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(o.mimeType)){ opts = o; break; } }
  if(!opts) opts = { mimeType:'video/webm', videoBitsPerSecond: 14000000 };

  const rec = new MediaRecorder(stream, opts);
  rec.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
  rec.onstop = () => {
    lastBlob = new Blob(chunks, { type: (rec.mimeType || opts.mimeType) });
    const url = URL.createObjectURL(lastBlob);
    vidEl.src = url; vidEl.load(); vidEl.play();
    resultEl.style.display = 'flex';
    setStatus('Recording complete — preview ready. Tap “Save video”.');
  };
  rec.start();
  setStatus(`Recording… (${opts.mimeType})`);

  let frame = 0;
  const tick = () => {
    const tNorm = frame / TOTAL;
    recRenderer.draw(tNorm);
    frame++;
    if(frame < TOTAL){ setTimeout(tick, 1000/FPS); }
    else { setTimeout(()=> rec.stop(), 50); }
  };
  tick();
}

// Buttons
document.getElementById('startBtn').addEventListener('click', startRecording);
saveBtn.addEventListener('click', ()=>{
  if(!lastBlob) return;
  const url = URL.createObjectURL(lastBlob);
  const a = document.getElementById('downloadLink');
  const ext = (lastBlob.type.includes('mp4') ? 'mp4' : 'webm');
  a.href = url; a.download = `kaleido-reel-1080x1920-15s.${ext}`;
  a.style.display = 'inline';
  a.click();
});
againBtn.addEventListener('click', startRecording);
</script>
</body>
</html>
